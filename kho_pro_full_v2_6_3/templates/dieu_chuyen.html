{% extends 'base.html' %}
{% block content %}

<div class="card">
  <h2 class="card__title">üîÅ ƒêi·ªÅu chuy·ªÉn n·ªôi b·ªô</h2>

  <form method="post" class="form-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
    <!-- M√£ ƒëi·ªÅu chuy·ªÉn -->
    <div style="grid-column:span 2;">
      <label>M√£ ƒëi·ªÅu chuy·ªÉn</label>
      <input class="input" name="id_dc" value="{{ next_id_dc }}" readonly>
    </div>

    <!-- Kho ngu·ªìn -->
    <div>
      <label>Kho ngu·ªìn</label>
      <select class="input" name="kho_src" required>
        <option value="">-- Ch·ªçn kho ngu·ªìn --</option>
        {% for k in khos %}
          <option value="{{ k.id_kho }}">{{ k.id_kho }} - {{ k.ten_kho }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Kho ƒë√≠ch -->
    <div>
      <label>Kho ƒë√≠ch</label>
      <select class="input" name="kho_dst" required>
        <option value="">-- Ch·ªçn kho ƒë√≠ch --</option>
        {% for k in khos %}
          <option value="{{ k.id_kho }}">{{ k.id_kho }} - {{ k.ten_kho }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Ng√†y ƒëi·ªÅu chuy·ªÉn + n√∫t l·∫•y th·ªùi gian -->
    <div>
      <label>Ng√†y ƒëi·ªÅu chuy·ªÉn</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input class="input" type="datetime-local" name="ngay" id="ngayDc" required style="flex:1;">
        <button type="button" class="btn small ghost" onclick="layThoiGian()">
          üïí L·∫•y th·ªùi gian
        </button>
      </div>
    </div>

    <!-- Ghi ch√∫ -->
    <div>
      <label>Ghi ch√∫</label>
      <input class="input" name="ghi_chu" placeholder="(t√πy ch·ªçn)">
    </div>

    <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
    <div style="grid-column:span 2;">
      <h3 style="margin:6px 0 8px 0;">Chi ti·∫øt s·∫£n ph·∫©m</h3>
      <div class="table-wrapper">
        <table class="table" id="linesTable">
          <thead>
            <tr>
              <th style="width:55%;">S·∫£n ph·∫©m</th>
              <th style="width:25%;">S·ªë l∆∞·ª£ng</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <select class="input" name="id_sp[]" required>
                  <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                  {% for sp in sps %}
                    <option value="{{ sp.id_san_pham }}">{{ sp.id_san_pham }} - {{ sp.ten_san_pham }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <input class="input" name="so_luong[]" type="number" min="1" value="1" required>
              </td>
              <td>
                <button class="btn small ghost" type="button" onclick="addRow()">+ Th√™m d√≤ng</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- N√∫t submit -->
    <div style="grid-column:span 2; margin-top:8px;">
      <button class="btn" type="submit">‚úÖ Ghi nh·∫≠n ƒëi·ªÅu chuy·ªÉn</button>
    </div>
  </form>
</div>

{% if recent %}
<div class="card" style="margin-top:16px;">
  <h3 class="card__title">üìú L·ªãch s·ª≠ ƒëi·ªÅu chuy·ªÉn g·∫ßn nh·∫•t</h3>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>M√£ DC</th>
          <th>Ng√†y</th>
          <th>Kho ngu·ªìn</th>
          <th>Kho ƒë√≠ch</th>
          <th>M√£ SP</th>
          <th>T√™n SP</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Ghi ch√∫</th>
        </tr>
      </thead>
      <tbody>
        {% for hdr, ct in recent %}
        <tr>
          <td>{{ hdr.id_dieu_chuyen }}</td>
          <td>{{ hdr.ngay_dc.strftime('%d/%m/%Y %H:%M') if hdr.ngay_dc else '' }}</td>
          <td>{{ hdr.kho_nguon }}</td>
          <td>{{ hdr.kho_dich }}</td>
          <td>{{ ct.id_san_pham }}</td>
          <td>
            {% for sp in sps %}
              {% if sp.id_san_pham == ct.id_san_pham %}
                {{ sp.ten_san_pham }}
              {% endif %}
            {% endfor %}
          </td>
          <td>{{ ct.so_luong }}</td>
          <td>{{ hdr.ghi_chu or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<script>
  // === N√∫t "L·∫•y th·ªùi gian": ch·ªâ g√°n khi b·∫•m n√∫t (kh√¥ng auto) ===
  function layThoiGian() {
    const now = new Date();
    const y  = now.getFullYear();
    const m  = String(now.getMonth() + 1).padStart(2, '0');
    const d  = String(now.getDate()).padStart(2, '0');
    const h  = String(now.getHours()).padStart(2, '0');
    const mi = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('ngayDc').value = `${y}-${m}-${d}T${h}:${mi}`;
  }

  // === Th√™m d√≤ng s·∫£n ph·∫©m ===
  function addRow() {
    const tbody = document.querySelector('#linesTable tbody');
    const tr0 = tbody.firstElementChild;
    const tr = tr0.cloneNode(true);

    tr.querySelector('select[name="id_sp[]"]').value = '';
    tr.querySelector('input[name="so_luong[]"]').value = 1;

    const actionCell = tr.querySelector('td:last-child');
    actionCell.innerHTML = '';
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'btn small danger';
    delBtn.textContent = 'X√≥a';
    delBtn.addEventListener('click', () => tr.remove());
    actionCell.appendChild(delBtn);

    tbody.appendChild(tr);
  }
</script>

{% endblock %}
