{% extends 'base.html' %}
{% block content %}

<div class="card">
  <h2 class="card__title">üì§ Xu·∫•t kho</h2>

  <h3 style="margin-bottom:8px; color:#2563eb;">Th√¥ng tin phi·∫øu xu·∫•t</h3>

  <!-- ====== FORM L·∫¨P PHI·∫æU XU·∫§T ====== -->
  <form method="post" class="form-grid"
        style="max-width:650px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">

    <div style="grid-column:span 2;">
      <label>ID h√≥a ƒë∆°n</label>
      <input class="input" name="id_hd" value="{{ next_id_hd }}" readonly>
    </div>

    <div style="grid-column:span 2;">
      <label>Kho</label>
      <select class="input" name="id_kho" required {% if IS_STAFF %}disabled{% endif %}>
        <option value="">-- Ch·ªçn kho --</option>
        {% for k in khos %}
          <option value="{{ k.id_kho }}" {{ 'selected' if selected_kho==k.id_kho else '' }}>
            {{ k.id_kho }} - {{ k.ten_kho }}
          </option>
        {% endfor %}
      </select>
      {% if IS_STAFF %}
        <!-- staff: √©p kho = assigned_kho -->
        <input type="hidden" name="id_kho" value="{{ selected_kho }}">
      {% endif %}
    </div>

    <div style="grid-column:span 2;">
      <label>S·∫£n ph·∫©m</label>
      <select class="input" name="id_sp" required>
        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
        {% for sp in sps %}
          <option value="{{ sp.id_san_pham }}">{{ sp.id_san_pham }} - {{ sp.ten_san_pham }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>S·ªë l∆∞·ª£ng xu·∫•t</label>
      <input class="input" name="so_luong" type="number" min="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng..." required>
    </div>

    <div>
      <label>Gi√° b√°n</label>
      <input class="input" name="gia_ban" type="number" step="0.01" placeholder="Nh·∫≠p gi√° b√°n..." required>
    </div>

    <div style="grid-column:span 2;">
      <label>Ng√†y xu·∫•t</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input class="input" name="ngay" id="ngayXuat" type="datetime-local" style="flex:1;" required>
        <button type="button" class="btn small ghost" onclick="layThoiGianXuat()">üïí L·∫•y th·ªùi gian</button>
      </div>
    </div>

    <div>
      <label>Nh√¢n vi√™n</label>
      {% if IS_STAFF %}
        <select class="input" disabled>
          <option selected>{{ staff_nv_label }}</option>
        </select>
        <!-- server t·ª± map username->m√£ NV; hidden ƒë·ªÉ h·ª£p l·ªá form -->
        <input type="hidden" name="id_nv" value="">
      {% else %}
        <select class="input" name="id_nv" required>
          <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
          {% for nv in nvs %}
            {% set ten_nv = ((nv.ho or '') ~ ' ' ~ (nv.ten_dem or '') ~ ' ' ~ (nv.ten or '')) | trim %}
            <option value="{{ nv.id_nhan_vien }}">{{ nv.id_nhan_vien }} - {{ ten_nv or 'NV kh√¥ng t√™n' }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>

    <div>
      <label>Xe v·∫≠n chuy·ªÉn</label>
      <select class="input" name="id_xe" required>
        <option value="">-- Ch·ªçn xe --</option>
        {% for xe in xes %}
          {% set tai_xe = ((xe.ho or '') ~ ' ' ~ (xe.ten_dem or '') ~ ' ' ~ (xe.ten or '')) | trim %}
          <option value="{{ xe.id_xe_van_chuyen }}">{{ xe.id_xe_van_chuyen }} - {{ xe.bien_so }} - {{ tai_xe or 'T√†i x·∫ø' }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="grid-column:span 2;">
      <label>Kh√°ch h√†ng</label>
      <select class="input" name="id_kh" required>
        <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
        {% for kh in khs %}
          {% set ten_kh = ((kh.ho or '') ~ ' ' ~ (kh.ten_dem or '') ~ ' ' ~ (kh.ten or '')) | trim %}
          <option value="{{ kh.id_khach_hang }}">{{ kh.id_khach_hang }} - {{ ten_kh or 'KH kh√¥ng t√™n' }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="grid-column:span 2; text-align:left; margin-top:10px;">
      <button class="btn">‚úÖ L∆∞u phi·∫øu xu·∫•t</button>
    </div>
  </form>
</div>

<!-- ====== CARD: B·ªò L·ªåC L·ªäCH S·ª¨ ====== -->
<section class="card" style="margin-top:12px;">
  <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
    <div style="font-size:22px;">üîé</div>
    <h3 style="margin:0;">B·ªô l·ªçc</h3>
  </div>

  <form method="get" class="filter-row">
    {% if IS_STAFF %}
      <!-- Staff ch·ªâ l·ªçc Xe & Kh√°ch; kho b·ªã kh√≥a = assigned_kho -->
      <label>Xe VC</label>
      <select class="input" name="f_xe">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for xe in xes %}
          {% set tai_xe = ((xe.ho or '') ~ ' ' ~ (xe.ten_dem or '') ~ ' ' ~ (xe.ten or '')) | trim %}
          <option value="{{ xe.id_xe_van_chuyen }}" {{ 'selected' if f_xe==xe.id_xe_van_chuyen else '' }}>
            {{ xe.id_xe_van_chuyen }} - {{ xe.bien_so }} - {{ tai_xe or 'T√†i x·∫ø' }}
          </option>
        {% endfor %}
      </select>

      <label>Kh√°ch h√†ng</label>
      <select class="input" name="f_kh">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for kh in khs %}
          {% set ten_kh = ((kh.ho or '') ~ ' ' ~ (kh.ten_dem or '') ~ ' ' ~ (kh.ten or '')) | trim %}
          <option value="{{ kh.id_khach_hang }}" {{ 'selected' if f_kh==kh.id_khach_hang else '' }}>
            {{ kh.id_khach_hang }} - {{ ten_kh or 'KH kh√¥ng t√™n' }}
          </option>
        {% endfor %}
      </select>

      <!-- √©p kho b·∫±ng hidden -->
      <input type="hidden" name="f_kho" value="{{ selected_kho }}">

    {% else %}
      <!-- Admin: ƒë·ªß 4 b·ªô l·ªçc NV/Xe/KH/Kho -->
      <label>Nh√¢n vi√™n</label>
      <select class="input" name="f_nv">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for nv in nvs %}
          {% set ten_nv = ((nv.ho or '') ~ ' ' ~ (nv.ten_dem or '') ~ ' ' ~ (nv.ten or '')) | trim %}
          <option value="{{ nv.id_nhan_vien }}" {{ 'selected' if f_nv==nv.id_nhan_vien else '' }}>
            {{ nv.id_nhan_vien }} - {{ ten_nv or 'NV kh√¥ng t√™n' }}
          </option>
        {% endfor %}
      </select>

      <label>Xe VC</label>
      <select class="input" name="f_xe">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for xe in xes %}
          {% set tai_xe = ((xe.ho or '') ~ ' ' ~ (xe.ten_dem or '') ~ ' ' ~ (xe.ten or '')) | trim %}
          <option value="{{ xe.id_xe_van_chuyen }}" {{ 'selected' if f_xe==xe.id_xe_van_chuyen else '' }}>
            {{ xe.id_xe_van_chuyen }} - {{ xe.bien_so }} - {{ tai_xe or 'T√†i x·∫ø' }}
          </option>
        {% endfor %}
      </select>

      <label>Kh√°ch h√†ng</label>
      <select class="input" name="f_kh">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for kh in khs %}
          {% set ten_kh = ((kh.ho or '') ~ ' ' ~ (kh.ten_dem or '') ~ ' ' ~ (kh.ten or '')) | trim %}
          <option value="{{ kh.id_khach_hang }}" {{ 'selected' if f_kh==kh.id_khach_hang else '' }}>
            {{ kh.id_khach_hang }} - {{ ten_kh or 'KH kh√¥ng t√™n' }}
          </option>
        {% endfor %}
      </select>

      <label>Kho</label>
      <select class="input" name="f_kho">
        <option value="ALL" {{ 'selected' if f_kho=='ALL' else '' }}>-- T·∫•t c·∫£ --</option>
        {% for k in khos %}
          <option value="{{ k.id_kho }}" {{ 'selected' if f_kho==k.id_kho else '' }}>
            {{ k.id_kho }} - {{ k.ten_kho }}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    <button class="btn small" type="submit">L·ªçc</button>
    <a class="btn small ghost" href="{{ request.path }}">X√≥a l·ªçc</a>
  </form>
</section>

<!-- ====== L·ªäCH S·ª¨ ====== -->
<div class="card" style="margin-top:16px;">
  <h3 class="card__title">üìú L·ªãch s·ª≠ xu·∫•t kho g·∫ßn nh·∫•t</h3>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>H√≥a ƒë∆°n</th>
          <th>S·∫£n ph·∫©m</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√° b√°n</th>
          <th>Ng√†y xu·∫•t</th>
          <th>Nh√¢n vi√™n</th>
          <th>Xe VC</th>
          <th>Kh√°ch h√†ng</th>
          <th>Kho</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
          <tr>
            <td>{{ r.id_hoa_don_xuat }}</td>
            <td>{{ r.id_san_pham }}</td>
            <td>{{ r.so_san_pham_xuat }}</td>
            <td>{{ '{:,.0f}'.format(r.gia_ban|float) }}</td>
            <td>{{ r.ngay_xuat }}</td>
            <td>{{ r.id_nhan_vien or '‚Äî' }}</td>
            <td>{{ r.id_xe_van_chuyen }}</td>
            <td>{{ r.id_khach_hang }}</td>
            <td>{{ r.id_kho }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ====== STYLE CHO H√ÄNG L·ªåC ====== -->
<style>
  .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
  .filter-row label{white-space:nowrap;margin-right:4px}
  .filter-row .input{min-width:170px}
  @media (max-width: 1100px){.filter-row{flex-wrap:wrap}}
</style>

<script>
  function layThoiGianXuat() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const h = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    document.getElementById("ngayXuat").value = `${y}-${m}-${d}T${h}:${min}`;
  }
</script>

{% endblock %}
