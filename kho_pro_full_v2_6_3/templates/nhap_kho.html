{% extends 'base.html' %}
{% block content %}

<div class="card">
  <h2 class="card__title">üì• Nh·∫≠p kho</h2>

  <h3 style="margin-bottom:8px; color:#2563eb;">Th√¥ng tin phi·∫øu nh·∫≠p</h3>

  <form method="post" class="form-grid"
        style="max-width:650px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">

    <div style="grid-column:span 2;">
      <label>ID h√≥a ƒë∆°n</label>
      <input class="input" name="id_hd" value="{{ next_id_hd }}" readonly>
    </div>

    <div style="grid-column:span 2;">
      <label>Kho</label>
      {% if IS_STAFF %}
        <select class="input" disabled>
          <option selected>{{ selected_kho }}</option>
        </select>
        <input type="hidden" name="id_kho" value="{{ selected_kho }}">
      {% else %}
        <select class="input" name="id_kho" required>
          <option value="">-- Ch·ªçn kho --</option>
          {% for k in khos %}
            <option value="{{ k.id_kho }}" {{ 'selected' if selected_kho==k.id_kho else '' }}>
              {{ k.id_kho }} - {{ k.ten_kho }}
            </option>
          {% endfor %}
        </select>
      {% endif %}
    </div>

    <div style="grid-column:span 2;">
      <label>S·∫£n ph·∫©m</label>
      <select class="input" name="id_sp" required>
        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
        {% for sp in sps %}
          <option value="{{ sp.id_san_pham }}">{{ sp.id_san_pham }} - {{ sp.ten_san_pham }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>S·ªë l∆∞·ª£ng</label>
      <input class="input" name="so_luong" type="number" min="1" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng..." required>
    </div>

    <div>
      <label>Gi√° nh·∫≠p</label>
      <input class="input" name="gia_nhap" type="number" step="0.01" placeholder="Nh·∫≠p gi√° nh·∫≠p..." required>
    </div>

    <div style="grid-column:span 2;">
      <label>Ng√†y nh·∫≠p</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input class="input" name="ngay" id="ngayNhap" type="datetime-local" style="flex:1;" required>
        <button type="button" class="btn small ghost" onclick="layThoiGianNhap()">üïí L·∫•y th·ªùi gian</button>
      </div>
    </div>

    <div>
      <label>Nh√¢n vi√™n</label>
      {% if IS_STAFF %}
        <select class="input" disabled>
          <option selected>{{ staff_nv_label }}</option>
        </select>
        <input type="hidden" name="id_nv" value="{{ staff_nv_id }}">
      {% else %}
        <select class="input" name="id_nv" required>
          <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
          {% for nv in nvs %}
            {% set ten_nv = ((nv.ho or '') ~ ' ' ~ (nv.ten_dem or '') ~ ' ' ~ (nv.ten or '')) | trim %}
            <option value="{{ nv.id_nhan_vien }}" {{ 'selected' if f_nv|int==nv.id_nhan_vien else '' }}>
              {{ nv.id_nhan_vien }} - {{ ten_nv or 'NV kh√¥ng t√™n' }}
            </option>
          {% endfor %}
        </select>
      {% endif %}
    </div>

    <div>
      <label>Nh√† cung c·∫•p</label>
      <select class="input" name="id_ncc" required>
        <option value="">-- Ch·ªçn NCC --</option>
        {% for ncc in nccs %}
          <option value="{{ ncc.id_nha_cung_cap }}" {{ 'selected' if f_ncc|int==ncc.id_nha_cung_cap else '' }}>
            {{ ncc.id_nha_cung_cap }} - {{ ncc.ten_nha_cung_cap }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div style="grid-column:span 2; text-align:left; margin-top:10px;">
      <button class="btn">‚úÖ L∆∞u phi·∫øu nh·∫≠p</button>
    </div>
  </form>
</div>

<section class="card" style="margin-top:12px;">
  <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
    <div style="font-size:22px;">üîé</div>
    <h3 style="margin:0;">B·ªô l·ªçc</h3>
  </div>

  <form method="get" class="filter-row">
    {% if not IS_STAFF %}
      <label>Nh√¢n vi√™n</label>
      <select class="input" name="f_nv">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for nv in nvs %}
          {% set ten_nv = ((nv.ho or '') ~ ' ' ~ (nv.ten_dem or '') ~ ' ' ~ (nv.ten or '')) | trim %}
          <option value="{{ nv.id_nhan_vien }}" {{ 'selected' if f_nv|int==nv.id_nhan_vien else '' }}>
            {{ nv.id_nhan_vien }} - {{ ten_nv or 'NV kh√¥ng t√™n' }}
          </option>
        {% endfor %}
      </select>

      <label>Kho</label>
      <select class="input" name="f_kho">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for k in khos %}
          <option value="{{ k.id_kho }}" {{ 'selected' if selected_kho==k.id_kho else '' }}>
            {{ k.id_kho }} - {{ k.ten_kho }}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    <label>Nh√† cung c·∫•p</label>
    <select class="input" name="f_ncc">
      <option value="">-- T·∫•t c·∫£ --</option>
      {% for ncc in nccs %}
        <option value="{{ ncc.id_nha_cung_cap }}" {{ 'selected' if f_ncc|int==ncc.id_nha_cung_cap else '' }}>
          {{ ncc.id_nha_cung_cap }} - {{ ncc.ten_nha_cung_cap }}
        </option>
      {% endfor %}
    </select>

    <button class="btn small" type="submit">L·ªçc</button>
    <a class="btn small ghost" href="{{ request.path }}">X√≥a l·ªçc</a>
  </form>
</section>

<div class="card" style="margin-top:16px;">
  <h3 class="card__title">üìú L·ªãch s·ª≠ nh·∫≠p kho g·∫ßn nh·∫•t</h3>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>H√≥a ƒë∆°n</th>
          <th>S·∫£n ph·∫©m</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√° nh·∫≠p</th>
          <th>Ng√†y nh·∫≠p</th>
          <th>Nh√¢n vi√™n</th>
          <th>Nh√† cung c·∫•p</th>
          <th>Kho</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
          <tr>
            <td>{{ r.id_hoa_don_nhap }}</td>
            <td>{{ r.id_san_pham }}</td>
            <td>{{ r.so_san_pham_nhap }}</td>
            <td>{{ '{:,.0f}'.format(r.gia_nhap|float) }}</td>
            <td>{{ r.ngay_nhap }}</td>
            <td>{{ r.id_nhan_vien or '‚Äî' }}</td>
            <td>{{ r.id_nha_cung_cap }}</td>
            <td>{{ r.id_kho }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
  .filter-row label{white-space:nowrap;margin-right:4px}
  .filter-row .input{min-width:170px}
  @media (max-width: 1100px){.filter-row{flex-wrap:wrap}}
</style>

<script>
  function layThoiGianNhap() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const h = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    document.getElementById("ngayNhap").value = `${y}-${m}-${d}T${h}:${min}`;
  }
</script>

{% endblock %}
