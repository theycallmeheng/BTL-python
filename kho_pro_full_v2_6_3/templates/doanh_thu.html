{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2 class="card__title">üìä L·ªçc d·ªØ li·ªáu </h2>

  <form method="get" action="{{ url_for('doanh_thu_view') }}"
        class="form-grid"
        style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px; align-items:end;">
    <div>
      <label>Kho</label>
      <select class="input" name="kho">
        {% if IS_ADMIN %}
          <option value="ALL" {{ 'selected' if selected_kho=='ALL' else '' }}>ALL - T·∫•t c·∫£</option>
        {% endif %}
        {% for k in khos %}
          <option value="{{ k.id_kho }}" {{ 'selected' if selected_kho==k.id_kho else '' }}>
            {{ k.id_kho }} - {{ k.ten_kho }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>T·ª´</label>
      <input class="input" type="date" name="from" value="{{ date_from or '' }}">
    </div>

    <div>
      <label>ƒê·∫øn</label>
      <input class="input" type="date" name="to" value="{{ date_to or '' }}">
    </div>

    <div>
      <button class="btn" type="submit" style="margin-top:4px;">üîç Xem</button>
    </div>
  </form>

<!--  <div class="stats-3" style="margin-top:16px;">-->
<!--    <div class="stat">-->
<!--      <div class="label">Doanh thu</div>-->
<!--      <div class="value">{{ '{:,.0f}'.format(total_rev or 0) }}</div>-->
<!--    </div>-->
<!--    <div class="stat">-->
<!--      <div class="label">Gi√° v·ªën (x·∫•p x·ªâ)</div>-->
<!--      <div class="value">{{ '{:,.0f}'.format(total_cogs or 0) }}</div>-->
<!--    </div>-->
<!--    <div class="stat">-->
<!--      <div class="label">L·ª£i nhu·∫≠n</div>-->
<!--      <div class="value">{{ '{:,.0f}'.format(total_profit or 0) }}</div>-->
<!--    </div>-->
<!--  </div>-->
</div>

<!-- DOANH THU THEO NG√ÄY -->
<div class="card" style="margin-top:16px;">
  <h3 class="card__title">üìÖ Doanh thu theo ng√†y</h3>
  <div class="table-wrapper">
    <table class="table table-bordered" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background-color:#f8f9fa;">
          <th style="width:25%; text-align:left;">Ng√†y</th>
          <th style="width:25%; text-align:right;">Doanh thu</th>
          <th style="width:25%; text-align:right;">Gi√° v·ªën</th>
          <th style="width:25%; text-align:right;">L·ª£i nhu·∫≠n</th>
        </tr>
      </thead>
      <tbody>
      {% for r in rows %}
        <tr>
          <td style="padding:8px 12px;">{{ r.date }}</td>
          <td style="text-align:right; padding:8px 12px;">{{ '{:,.0f}'.format(r.revenue or 0) }}</td>
          <td style="text-align:right; padding:8px 12px;">{{ '{:,.0f}'.format(r.cogs or 0) }}</td>
          <td style="text-align:right; padding:8px 12px; font-weight:bold; color:#198754;">
            {{ '{:,.0f}'.format(r.profit or 0) }}
          </td>
        </tr>
      {% endfor %}
      {% if rows|length == 0 %}
        <tr><td colspan="4" class="muted" style="text-align:center; padding:8px;">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng ƒë√£ ch·ªçn.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- TOP B√ÅN -->
<div class="grid-2" style="margin-top:16px;">
  <div class="card">
    <h3 class="card__title">üèÜ Top theo s·ªë l∆∞·ª£ng</h3>
    <div class="table-wrapper">
      <table class="table table-bordered" style="width:100%;">
        <thead>
          <tr style="background-color:#f8f9fa;">
            <th style="text-align:left;">M√£ SP</th>
            <th style="text-align:right;">SL</th>
          </tr>
        </thead>
        <tbody>
        {% for sp, qty in top_by_qty %}
          <tr><td>{{ sp }}</td><td style="text-align:right;">{{ (qty or 0) | int }}</td></tr>
        {% endfor %}
        {% if top_by_qty|length == 0 %}
          <tr><td colspan="2" class="muted" style="text-align:center;">Ch∆∞a c√≥ ph√°t sinh.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 class="card__title">üí∞ Top theo doanh thu</h3>
    <div class="table-wrapper">
      <table class="table table-bordered" style="width:100%;">
        <thead>
          <tr style="background-color:#f8f9fa;">
            <th style="text-align:left;">M√£ SP</th>
            <th style="text-align:right;">Doanh thu</th>
          </tr>
        </thead>
        <tbody>
        {% for sp, amt in top_by_rev %}
          <tr><td>{{ sp }}</td><td style="text-align:right;">{{ '{:,.0f}'.format(amt or 0) }}</td></tr>
        {% endfor %}
        {% if top_by_rev|length == 0 %}
          <tr><td colspan="2" class="muted" style="text-align:center;">Ch∆∞a c√≥ ph√°t sinh.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- BI·ªÇU ƒê·ªí -->
<div class="card" style="margin-top:16px;">
  <h3 class="card__title">üìà Bi·ªÉu ƒë·ªì doanh thu & l·ª£i nhu·∫≠n</h3>
  <canvas id="revChart" style="max-height:320px;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ rows | map(attribute='date') | list | tojson }};
const dataRev = {{ rows | map(attribute='revenue') | list | tojson }};
const dataProfit = {{ rows | map(attribute='profit') | list | tojson }};
const ctx = document.getElementById('revChart');
if (ctx && labels.length){
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Doanh thu', data: dataRev, borderColor: '#007bff', fill:false },
        { label: 'L·ª£i nhu·∫≠n', data: dataProfit, borderColor: '#28a745', fill:false }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}
</script>
{% endblock %}
